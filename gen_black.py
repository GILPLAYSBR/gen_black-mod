


#Set the base directory
#base_dir="Examples\\head"
#base_dir="Inport"
#base_dir="Examples\\XR_wing"

#base_dir="Examples\\XF_seat"
#base_dir="Examples\\S15"
#base_dir="Examples\\RAC_skin"
#base_dir="Examples\\roof"
#base_dir="Examples\\RT"
#base_dir="Examples\\F109"
#base_dir="Examples\\Silvia"
#base_dir="Examples\\A8"
#base_dir="Examples\\Blackwood"
#base_dir="Examples\\S2000"
#base_dir="Examples\\Corvette"
#base_dir="Examples\\Sunny"
#base_dir="Examples\\200X"
#base_dir="Examples\\EVO"
#base_dir="Examples\\hC"
#base_dir="Examples\\FD3S"
#base_dir="Examples\\capa"
#base_dir="Examples\\ASCARI"
#base_dir="Examples\\NSX"
#base_dir="Examples\\R33"
#base_dir="Examples\\GOLF"
#base_dir="Examples\\STRADA"
#base_dir="Examples\\1979"
#base_dir="Examples\\cmd"
#base_dir="Examples\\Freios"
#base_dir="Examples\\R32"
#base_dir="Examples\\2000GT"
#base_dir="Examples\\TUNINGRAC"
#base_dir="Examples\\XRP"
#base_dir="Examples\\LAMBO"
#base_dir="Examples\\SALLEN"
#base_dir="Examples\\BMW"
#base_dir="Examples\\calota"
#base_dir="Examples\\calotaRB"
#base_dir="Examples\\calotafx"
#base_dir="Examples\\calotafz"
#base_dir="Examples\\XRR"
#base_dir="Examples\\Rodenha"
#base_dir="Examples\\Rodenha2"
#base_dir="Examples\\Rodenha3"
#base_dir="Examples\\Rodenha4"
#base_dir="Examples\\Subaru"
#base_dir="Examples\\calotaRA"
#base_dir="Examples\\calotauf"
#base_dir="Examples\\calotalx"
#base_dir="Examples\\RODA2"
#base_dir="Examples\\S14Stock"
#base_dir="Examples\\RODAG"
#base_dir="Examples\\RODAN"
#base_dir="Examples\\Ford"
#base_dir="Examples\\Fiat"
#base_dir="Examples\\MX5"
#base_dir="Examples\\palio"
#base_dir="Examples\\charger"
#base_dir="Examples\\JZ"
#base_dir="Examples\\Roda_pekena"
#base_dir="Examples\\opala"
#base_dir="Examples\\brasilia"
#base_dir="Examples\\boneco"
#base_dir="Examples\\Zonda"
#base_dir="Examples\\ZondaRAC"
#base_dir="Examples\\Nova_Roda"
#base_dir="Examples\\Altezza"
#base_dir="Examples\\cromado"
#base_dir="Examples\\orbital"
#base_dir="Examples\\cool"
#base_dir="Examples\\430"
#base_dir="Examples\\S13"
#base_dir="Examples\\G35"
#base_dir="Examples\\trueno"
#base_dir="Examples\\XR15"
#base_dir="Examples\\HachiHoku"
#base_dir="Examples\\carlton"
#base_dir="Examples\\iron"
#base_dir="Examples\\mclaren"
#base_dir="Examples\\ESCALADE"
#base_dir="Examples\\ESC"
#base_dir="Examples\\GIO"
#base_dir="Examples\\DRIFT"
#base_dir="Examples\\ENKEI"
#base_dir="Examples\\WORK"
#base_dir="Examples\\orbital"
#base_dir="Examples\\HR"
#base_dir="Examples\\XRG_W"
#base_dir="Examples\\XF_TUNING"
#base_dir="Examples\\DUB"
#base_dir="Examples\\GIRL"
#base_dir="Examples\\AE86W"
#base_dir="Examples\\R10"
#base_dir="Examples\\rollcage"

#base_dir="Examples\\sombra"
#base_dir="Examples\\2J"
#base_dir="Examples\\R10"
#base_dir="Examples\\1992"
#base_dir="Examples\\liso"
#base_dir="Examples\\maverick"

#set the file cor get the command list
#file_command="cmd.txt"

#file_input="C:\\Users\\damian\\Downloads\\RevBouncer\\lfsdk\\lfsdk\\Inport\\XF.vob"
#file_input="D:\\Documents and Settings\\Henrique.CATALDO-FE60ADE\\Desktop\\Conversor\\FZ5.vob"
#file_input="D:\\Documents and Settings\\Henrique.CATALDO-FE60ADE\\Desktop\\Conversor\\FZ5O.vob"
#file_input="D:\\Documents and Settings\\Henrique.CATALDO-FE60ADE\\Desktop\\Conversor\\Blackwood.wld"
#file_input="D:\\Documents and Settings\\Henrique.CATALDO-FE60ADE\\Desktop\\Conversor\\S2000.vob"
#file_input="D:\\Documents and Settings\\Henrique.CATALDO-FE60ADE\\Desktop\\Conversor\\F08.vob"
#file_input="D:\\Documents and Settings\\Henrique.CATALDO-FE60ADE\\Desktop\\Conversor\\RB4.vob"
#file_input="D:\\Documents and Settings\\Henrique.CATALDO-FE60ADE\\Desktop\\Conversor\\XRT.vob"
#file_input="D:\\Documents and Settings\\Henrique.CATALDO-FE60ADE\\Desktop\\Conversor\\XRTinterio.vob"
#file_input="D:\\Documents and Settings\\Henrique.CATALDO-FE60ADE\\Desktop\\Conversor\\helmet.sre"
#file_input="D:\\Documents and Settings\\Henrique.CATALDO-FE60ADE\\Desktop\\Conversor\\LXInterior.vob"
#file_input="D:\\Documents and Settings\\Henrique.CATALDO-FE60ADE\\Desktop\\Conversor\\XR2.vob"
#file_input="D:\\Documents and Settings\\Henrique.CATALDO-FE60ADE\\Desktop\\Conversor\\XF.vob"
#file_input="D:\\Documents and Settings\\Henrique.CATALDO-FE60ADE\\Desktop\\Conversor\\FX.vob"
#file_input="D:\\Documents and Settings\\Henrique.CATALDO-FE60ADE\\Desktop\\Conversor\\XFG_wheel.vob"
#file_input="D:\\Documents and Settings\\Henrique.CATALDO-FE60ADE\\Desktop\\Conversor\\XRORIGINAL.vob"
#file_input="D:\\Documents and Settings\\Henrique.CATALDO-FE60ADE\\Desktop\\Conversor\\RAC.vob"
#file_input="D:\\Documents and Settings\\Henrique.CATALDO-FE60ADE\\Desktop\\Conversor\\XR22.vob"
#file_input="D:\\Documents and Settings\\Henrique.CATALDO-FE60ADE\\Desktop\\Conversor\\RODAZ27.vob"
#file_input="D:\\Documents and Settings\\Henrique.CATALDO-FE60ADE\\Desktop\\Conversor\\GRID.vob"
#file_input="D:\\Documents and Settings\\Henrique.CATALDO-FE60ADE\\Desktop\\Conversor\\XRAND.vob"
#file_input="D:\\Documents and Settings\\Henrique.CATALDO-FE60ADE\\Desktop\\Conversor\\XFG_wheel.vob"
#file_input="D:\\Documents and Settings\\Henrique.CATALDO-FE60ADE\\Desktop\\Conversor\\RB.vob"
#file_input="D:\\Documents and Settings\\Henrique.CATALDO-FE60ADE\\Desktop\\Conversor\\SKY.vob"
#file_input="D:\\Documents and Settings\\Henrique.CATALDO-FE60ADE\\Desktop\\Conversor\\UF22.vob"
#file_input="D:\\Documents and Settings\\Henrique.CATALDO-FE60ADE\\Desktop\\Conversor\\LX.vob"
#file_input="D:\\Documents and Settings\\Henrique.CATALDO-FE60ADE\\Desktop\\Conversor\\FI.vob"
#file_input="D:\\Documents and Settings\\Henrique.CATALDO-FE60ADE\\Desktop\\Conversor\\XR4.vob"
#file_input="D:\\Documents and Settings\\Henrique.CATALDO-FE60ADE\\Desktop\\Conversor\\Super.vob"
#file_input="D:\\Documents and Settings\\Henrique.CATALDO-FE60ADE\\Desktop\\Conversor\\RASuper.vob"
#file_input="D:\\Documents and Settings\\Henrique.CATALDO-FE60ADE\\Desktop\\Conversor\\RA22.vob"
#file_input="D:\\Documents and Settings\\Henrique.CATALDO-FE60ADE\\Desktop\\Conversor\\hmn.hmn"
#file_input="D:\\Documents and Settings\\Henrique.CATALDO-FE60ADE\\Desktop\\Conversor\\ALTEZZA.vob"
#file_input="D:\\Documents and Settings\\Henrique.CATALDO-FE60ADE\\Desktop\\Conversor\\VOLKTE37.CEM"
#file_input="D:\\Documents and Settings\\Henrique.CATALDO-FE60ADE\\Desktop\\Conversor\\XF22.vob"
#file_input="D:\\Documents and Settings\\Henrique.CATALDO-FE60ADE\\Desktop\\Conversor\\FZ4.vob"
#file_input="D:\\Documents and Settings\\Henrique.CATALDO-FE60ADE\\Desktop\\Conversor\\XRTinterio2.vob"
#file_input="D:\\Documents and Settings\\Henrique.CATALDO-FE60ADE\\Desktop\\Conversor\\SUPRA.vob"
#file_input="D:\\Documents and Settings\\Henrique.CATALDO-FE60ADE\\Desktop\\Conversor\\FB.vob"
#file_input="D:\\Documents and Settings\\Henrique.CATALDO-FE60ADE\\Desktop\\Conversor\\R8.vob"
#file_input="..\\veh\\XF.vob"

 
 

 




import blackwood
import objread


def get_optimized_vertex(  vlist , tol=0.001):
    #3ds eh tolo em otimizar os vertices
    n= len(vlist)
    vl=[ i+0 for i in range(n) ]
    return vl

    gs=0
    for i in range(n-1):
      for j in range(i+1,n):
        if abs(vlist[i][0]-  vlist[j][0])< tol  and abs(vlist[i][1]-  vlist[j][1])< tol and abs(vlist[i][2]-  vlist[j][2])< tol:
            vl[j]=i+0
            gs+=1
    msg(" vertex reconect %i"%(gs))        
    return vl            
        

def msg(s):
    print s
 
def process(  ):
  lns= open( file_command , "r" )

  o_vt, obj , obj_uv = {},{},{}
  vtab={}  #buffer for vertex
  for i in range(len(o_vt)): vtab[i]=None
  
  #set vars
  vob= blackwood.blk_file()
  vob.load(file_input  )  
  mirror = 1  #on
  imodel=0  #actual model
  vop=[]
  print "OBJ NAMES"
  for k in vob.get_obj_names():
      print k, " "*(20-len(k) ) ,  vob.get_obj_file_texture(k)
   
  enable = True
  for l in lns:
    li =l.split()
    if len(li)==0: continue
    if li[0]=="#": continue
    cmd= li[0].upper()
    print "___"*6
    print ">", l

    if cmd == "ENABLE":
       enable == True
    if cmd == "DISABLE":
       enable == False
       

    if enable == False:
       continue 

    
    if cmd=="LOAD":
         file_obj=li[1]
         o_vt, obj , obj_uv =objread.read_obj_faces_names( file_obj )
         vtab={}  #buffer for vertex
         for i in range(len(o_vt)): vtab[i]=None 
         vop= get_optimized_vertex( o_vt ) 
        
    if cmd=="MIRROR":
       if li[1].upper() == "ON":
          msg("MIRROR ON")  
          mirror=1 
       if li[1].upper() == "OFF":
          msg("MIRROR OFF")             
          mirror=0            
       if li[1].upper() == "FIX":
          msg("MIRROR FIX")             
          mirror=2

    if cmd=="MESH":
       mid=int(li[1])
       msg("set mesh as %i"%(mid))
       vob.set_mid(mid)
       vtab={}
       for i in range(len(o_vt)): vtab[i]=None 
       print "OBJ NAMES"
       for k in vob.get_obj_names():
         print k


    if cmd == "EXIT":
        break 
        
    if cmd=="DELETE_ALL" or cmd=="CLEAN_ALL" :
       #vob_name=li[0]
       df=0
       g= vob.get_obj_names()  
       dd=[  0 for i in range(vob.nf) ]
 
       for ij in range(vob.mn) : 
          flist= vob.get_face_list_id( ij )
          flist.sort()           
          msg("Delete %s"%(g[ij]) )
          for j in range( vob.nf -1, -1,-1): 
            fii= vob.off_fc + j*12  
            if (vob.data[fii+2] != ij ) or (vob.data[fii+4] !=0 ):
                #if vob.face_is_safe( j ):
                   vob.delete_face( j )
 
           


    if cmd=="MODEL":
       imodel= int(li[1])
       
    if cmd=="DELETE_MODEL" or cmd=="CLEAN_MODEL" :        
       vob_name=li[1] 
       df=0
       g= vob.get_obj_names()  
       if not(vob_name in g):
          msg("PART %s NOT FOUND "%(vob_name) ) 
       else:
          flist= vob.get_face_list(vob_name ,models=[ imodel ]  )
          flist.sort()           
          msg("Delete %s"%(vob_name) )
          for i in range(len(flist)-1, -1,-1):
              vob.delete_face_model( flist[i],imodel )
              df+=1
          msg("%i faces deleted "%(df) )


 
    if cmd=="DELETE_COL" or cmd=="CLEAN_COL" :
        
       vob_name=li[1]
       df=0
       g= vob.get_obj_names()  
       if not(vob_name in g):
          msg("PART %s NOT FOUND "%(vob_name) ) 
       else:
          vob.delete_faces_col( vob_name  )


          
          
    if cmd=="DELETE" or cmd=="CLEAN" :
        
       vob_name=li[1]
       df=0
       g= vob.get_obj_names()  
       if not(vob_name in g):
          msg("PART %s NOT FOUND "%(vob_name) ) 
       else:
          flist= vob.get_face_list(vob_name  )
          flist.sort()
          print "will delete ",len(flist)
          msg("Delete %s"%(vob_name) )
          for i in range(len(flist)-1, -1,-1):
              vob.delete_face( flist[i] )
              df+=1
          msg("%i faces deleted "%(df) )    

    if cmd=="ADD": 
       vob_name=li[1]
       obj_name=li[2]
       gl= vob.get_obj_names()  
       if not(vob_name in gl):
          msg("PART %s NOT FOUND "%(vob_name) )
          raise NameError 
       o_fc= obj[ obj_name  ]
       oid= gl.index( vob_name )
       recl=0
       fnew=0
       msg("ADD in %s  the contents of %s"%(vob_name, obj_name  ))
       vob.scan_vertex()
        
       #print "MIRROR = ", mirror
       for fi in range(len(o_fc)):
           ffj = vob.add_face()            
           vls=[]           #find 3 empty vertex
       
           for vk in [  o_fc[fi][0] ,o_fc[fi][1] ,o_fc[fi][2] ] :
               vo = vop[vk] +0
               
               if vtab[vo]==None   :
                  for vi in range(vob.nv)  :
                      if vob.vfree[vi]==0:
                         vob.vfree[vi]+=1 
                         vtab[vo] = vi+0
                         recl+=1
                         break                        
               if vtab[vo]==None :
                  vvk = vob.add_vertex()
                  vob.vfree[vvk]=1
                  fnew+=1                   
                  vtab[vo]=vvk+0          
                  
               vob.set_vertex( vtab[vo ], o_vt[vo][0],o_vt[vo][1],o_vt[vo][2] )
               #print vob.get_vertex( vtab[vo] ), o_vt[vo]
               vls.append(  vtab[vo] )               
           #print  vls
              
           vob.set_face( ffj, vls[0],vls[1],vls[2], oid ,mirror , model=imodel   )
           
 
       vob.scan_normals( oid  )        
       msg("reclicled %i vertex, new %i vertex"%(recl,fnew ))



    if cmd=="ADD_COL": 
       vob_name=li[1]
       obj_name=li[2]
       gl= vob.get_obj_names()  
       if not(vob_name in gl):
          msg("PART %s NOT FOUND "%(vob_name) )
          raise NameError 
       o_fc= obj[ obj_name  ]
       oid= gl.index( vob_name )
       recl=0
       fnew=0
       msg("ADD in %s  the contents of %s"%(vob_name, obj_name  ))
       vob.scan_vertex()
        
       #print "MIRROR = ", mirror
       for fi in range(len(o_fc)):
           ffj = vob.add_face()            
           vls=[]           #find 3 empty vertex
       
           for vk in [  o_fc[fi][0] ,o_fc[fi][1] ,o_fc[fi][2] ] :
               vo = vop[vk] +0
               
               if vtab[vo]==None   :
                  for vi in range(vob.nv)  :
                      if vob.vfree[vi]==0:
                         vob.vfree[vi]+=1 
                         vtab[vo] = vi+0
                         recl+=1
                         break                        
               if vtab[vo]==None :
                  vvk = vob.add_vertex()
                  vob.vfree[vvk]=1
                  fnew+=1                   
                  vtab[vo]=vvk+0          
                  
               vob.set_vertex( vtab[vo ], o_vt[vo][0],o_vt[vo][1],o_vt[vo][2] )
               #print vob.get_vertex( vtab[vo] ), o_vt[vo]
               vls.append(  vtab[vo] )               
           #print  vls
              
           vob.set_face( ffj, vls[0],vls[1],vls[2], oid ,mirror , model=imodel , aid =2  )
           
 
       vob.scan_normals( oid  )        
       msg("reclicled %i vertex, new %i vertex"%(recl,fnew )) 




       
    if cmd=="REPLACE":
       pass


    if cmd=="AJUST_TEXTURE_SIZE":
       vob_name= li[1]      
       
     
       rt = float(li[2])
       
       gl= vob.get_obj_names()  
       if not(vob_name in gl):
          msg("PART %s NOT FOUND "%(vob_name) )
          raise NameError
        
 
            
       morr = vob.get_orient_obj( vob_name )
       
       txid = vob.get_obj_texid(  vob_name )
       du,dv= vob.get_texture_slot_size(txid)

       print du,dv
       mat_name=  vob.get_obj_material(  vob_name  )  
       x1,x2, y1,y2= vob.get_material_bb(mat_name)
 
       print "limits originais",x1,x2,y1,y2 
       
       if x1*x2 > 0:
            extend==False
       else:
            extend=True
       pori= vob.get_orient_obj( vob_name )
       x1,x2,y1,y2 = vob.get_axis_limits( vob_name ,[0,1,2,3,4,5,6,7,8,9] ,pori )
       
       print "novos limites",x1,x2,y1,y2
       
       if extend and  morr != 3 :
          x2 = max( abs(x1),abs(x2) )
          x1 = -x2

       dx = abs(x2 -x1)
       dy = abs(y2 -y1)
       
       brt = du /float( dv )
       
       rt = rt* brt
       
       dyi = dy+0
       dxi = dx+0 
       


       
       
       while  dxi/dyi > rt :
           dyi = dyi*1.05
           
       while  dxi/dyi < rt :
           dxi = dxi*1.05
           


           
      
       sx= 1.0
       sy=1.0
       if dx>0 or dy >0 :
        sx = dxi /dx
        sy = dyi/ dy

       xm = 0.5*(x1+x2)
       ym = 0.5*(y1+y2)

       if extend: 
          px1,px2,py1,py2 = xm- dxi/2.0 , xm+dxi/2.0 , ym- dyi/2.0 , ym+dyi/2.0
       else:
          x1,x2, y1,y2= vob.get_material_bb(mat_name) 
          px1= x1
          px2= x1+dxi          
          py1= y1  
          py2= y1 + dyi
          
          
       
       mat_name=  vob.get_obj_material(  vob_name  )  
       x1,x2, y1,y2= vob.get_material_bb(mat_name)
       
       print x1,x2, y1,y2 , " ->  ", px1,px2,py1,py2
     
       vob.set_material_bb(  mat_name, px1,px2,py1,py2  )
      
        
    if cmd=="RENDER_TEMPLATE":
       vob_name= li[1]      
       file_temp= li[2]
       s_models= li[3:]       
       gl= vob.get_obj_names()  
       if not(vob_name in gl):
          msg("PART %s NOT FOUND "%(vob_name) )
          raise NameError  
       oid= gl.index( vob_name )
       for im in s_models:
          vob.render_template( oid, int(im) , file_temp)
          vob.render_template( oid, int(im) , file_temp,kside=1)  


         
    if cmd=="SET_TEXTURE_SLOT":
       vob_name= li[1]
       dds_name= li[2]
       orient=   li[4].upper()
       extend=   li[3].upper()
       if extend == "SINGLE":
           extend=False
       else:
            extend= True       
       slots = [ int(j) for j in li[5:] ]
       #print li
       gl= vob.get_obj_names()  
       if not(vob_name in gl):
          msg("PART %s NOT FOUND "%(vob_name) )
          raise NameError
       oid= gl.index( vob_name )
       dc= {"SIDE":3,"TOP":5,"BACK":2,"FRONT":1,"UNDER":6}
       if not(orient in dc.keys()):
          msg("SET_TEXTURE_SLOT accep only side,top,back,front planes")
          msg("SIDE receive: %s"%(orient ))
       x1,x2,y1,y2 = vob.get_axis_limits( vob_name ,[0,1,2,3,4,5,6,7,8,9] ,dc[orient.upper()] )
       #print "->",x1,x2,y1,y2 
       if extend and dc[orient.upper()] != 3:
          x2 = max( abs(x1),(x2) )
          x1 = -x2          
       mti, nada,nada2 = vob.get_mat_info()
       mat_name =  vob_name +"@"
       if not(mat_name in nada2):
          vob.add_material(   mat_name)       
 
       vob.set_obj_material(oid,mat_name)
       #print "AFTER ->",x1,x2,y1,y2 
       vob.set_material_bb(  mat_name, x1,x2,y1,y2)
       tid = vob.get_obj_texid( vob_name )              
       tf,ti,mt= vob.get_mat_pos()
       vi = ti[0] + tid * 24
       shin= vob.data[vi+16 ]+0

        
       tex_mirror= True 
       if dc == 3 : tex_mirror=False
       u,v,du,dv = blackwood.calc_slot( [ int( ki) for ki in slots  ]   )
       #mode tex_id  2 by default
       v= 64 - (v + dv)
       #x1,x2,y1,y2,du,dv = blackwood.fit_area(x1,x2,y1,y2,du,dv,two_side= tex_mirror , ratio =True )
       
       tex_file_id= vob.add_texture_file( dds_name  )       
       tex_id   = vob.set_tex_id(  vob_name+"@" , shin  ,  tex_file_id,  u,v,du,dv , orie=0 )        
       vob.set_material(  mat_name ,  dc[orient.upper()] , vob_name+"@"   )
 

       
       #vob.set_tex_id( 'Left',  2, 0, 0,0,du,dv,2 )
        
 


    if cmd=="NEW_OBJECT":
        vob_name= li[1]         
        vob.add_object( vob_name, ( 255,255,255 ) ,0  )
         
    if cmd=="WRITE":
        name= li[1]
        msg("WRITE OUT %s"%(name))
        vob.write(name )

        
    if cmd=="SET_COLOR":
        vob_name= li[1]
        shine= li[2].upper()
        rgb= [int(k) for k in li[3:]  ]
        sh= 0
        if shine == "SHINE": sh=0
        if shine == "OPAQUE": sh=1
              
        gl= vob.get_obj_names()  
        if not(vob_name in gl):
          msg("PART %s NOT FOUND "%(vob_name) )
          raise NameError
        oid= gl.index( vob_name )
        #print blackwood.ss( vob.data[vob.off_obj + oid *16:vob.off_obj + oid *16+4  ]    )      
        vob.data[vob.off_obj + oid *16   ] =rgb[0]
        vob.data[vob.off_obj + oid *16  +1 ] =rgb[1]             
        vob.data[vob.off_obj + oid *16  +2 ] =rgb[2]

              
        tid = vob.get_obj_texid( vob_name )
              
        tf,ti,mt= vob.get_mat_pos()
        vi = ti[0] + tid * 24
        vob.data[vi+16 ]= sh+0
              
              
          
  #msg("WRITE OUT %s"%(file_output))            
  #vob.write(file_output)

  
import os
 

os.chdir( base_dir)      
process()  
print "DONE"
